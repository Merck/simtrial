# Weighted logrank test

Weighted logrank test

## Usage

``` r
wlr(data, weight, return_variance = FALSE, ratio = NULL, formula = NULL)

# Default S3 method
wlr(data, weight, return_variance = FALSE, ratio = NULL, formula = NULL)

# S3 method for class 'tte_data'
wlr(data, weight, return_variance = FALSE, ratio = NULL, formula = NULL)

# S3 method for class 'counting_process'
wlr(data, weight, return_variance = FALSE, ratio = NULL, formula = NULL)
```

## Arguments

- data:

  Dataset (generated by
  [`sim_pw_surv()`](https://merck.github.io/simtrial/reference/sim_pw_surv.md))
  that has been cut by
  [`counting_process()`](https://merck.github.io/simtrial/reference/counting_process.md),
  [`cut_data_by_date()`](https://merck.github.io/simtrial/reference/cut_data_by_date.md),
  or
  [`cut_data_by_event()`](https://merck.github.io/simtrial/reference/cut_data_by_event.md).

- weight:

  Weighting functions, such as
  [`fh()`](https://merck.github.io/simtrial/reference/fh.md),
  [`mb()`](https://merck.github.io/simtrial/reference/mb.md), and
  [`early_zero()`](https://merck.github.io/simtrial/reference/early_zero.md).

- return_variance:

  A logical flag that, if `TRUE`, adds columns estimated variance for
  weighted sum of observed minus expected; see details; Default:
  `FALSE`.

- ratio:

  randomization ratio (experimental:control).

  - If the `data` is generated by simtrial, such as

    - `data = sim_pw_surv(...) |> cut_data_by_date(...)`

    - `data = sim_pw_surv(...) |> cut_data_by_event(...)`

    - `data = sim_pw_surv(...) |> cut_data_by_date(...) |> counting_process(...)`

    - `data = sim_pw_surv(...) |> cut_data_by_event(...) |> counting_process(...)`
      there is no need to input the `ratio`, as simtrial gets the
      `ratio` via the `block` arguments in
      [`sim_pw_surv()`](https://merck.github.io/simtrial/reference/sim_pw_surv.md).

  - If the `data` is a custom dataset (see Example 2) below,

    - Users are suggested to input the planned randomization ratio to
      `ratio`;

    - If not, simtrial takes the empirical randomization ratio.

- formula:

  A formula to specify the columns that contain the time-to-event,
  event, treatment, and stratum variables. Only used by the default S3
  method because the other classes aleady have the required column
  names. For stratified designs, the formula should have the form
  `Surv(tte, event) ~ treatment + strata(stratum)`, where `tte`,
  `event`, `treatment`, and `stratum` are the column names from `data`
  with the time-to-event measurement, event status, treatment group, and
  stratum, respectively. For unstratified designs, the formula can omit
  the stratum column: `Surv(tte, event) ~ treatment`.

## Value

A list containing the test method (`method`), parameters of this test
method (`parameter`), point estimate of the treatment effect
(`estimate`), standardized error of the treatment effect (`se`), Z-score
(`z`), p-values (`p_value`).

## Details

- \\z\\ - Standardized normal Fleming-Harrington weighted logrank test.

- \\i\\ - Stratum index.

- \\d_i\\ - Number of distinct times at which events occurred in stratum
  \\i\\.

- \\t\_{ij}\\ - Ordered times at which events in stratum \\i\\, \\j = 1,
  2, \ldots, d_i\\ were observed; for each observation, \\t\_{ij}\\
  represents the time post study entry.

- \\O\_{ij.}\\ - Total number of events in stratum \\i\\ that occurred
  at time \\t\_{ij}\\.

- \\O\_{ije}\\ - Total number of events in stratum \\i\\ in the
  experimental treatment group that occurred at time \\t\_{ij}\\.

- \\N\_{ij.}\\ - Total number of study subjects in stratum \\i\\ who
  were followed for at least duration.

- \\E\_{ije}\\ - Expected observations in experimental treatment group
  given random selection of \\O\_{ij.}\\ from those in stratum \\i\\ at
  risk at time \\t\_{ij}\\.

- \\V\_{ije}\\ - Hypergeometric variance for \\E\_{ije}\\ as produced in
  `Var` from
  [`counting_process()`](https://merck.github.io/simtrial/reference/counting_process.md).

- \\N\_{ije}\\ - Total number of study subjects in stratum \\i\\ in the
  experimental treatment group who were followed for at least duration
  \\t\_{ij}\\.

- \\E\_{ije}\\ - Expected observations in experimental group in stratum
  \\i\\ at time \\t\_{ij}\\ conditioning on the overall number of events
  and at risk populations at that time and sampling at risk observations
  without replacement: \$\$E\_{ije} = O\_{ij.} N\_{ije}/N\_{ij.}\$\$

- \\S\_{ij}\\ - Kaplan-Meier estimate of survival in combined treatment
  groups immediately prior to time \\t\_{ij}\\.

- \\\rho, \gamma\\ - Real parameters for Fleming-Harrington test.

- \\X_i\\ - Numerator for signed logrank test in stratum \\i\\ \$\$X_i =
  \sum\_{j=1}^{d\_{i}}
  S\_{ij}^\rho(1-S\_{ij}^\gamma)(O\_{ije}-E\_{ije})\$\$

- \\V\_{ij}\\ - Variance used in denominator for Fleming-Harrington
  weighted logrank tests \$\$V_i = \sum\_{j=1}^{d\_{i}}
  (S\_{ij}^\rho(1-S\_{ij}^\gamma))^2V\_{ij})\$\$ The stratified
  Fleming-Harrington weighted logrank test is then computed as: \$\$z =
  \sum_i X_i/\sqrt{\sum_i V_i}.\$\$

## Examples

``` r
# ---------------------- #
#      Example 1         #
#  Use dataset generated #
#     by simtrial        #
# ---------------------- #
x <- sim_pw_surv(n = 200) |> cut_data_by_event(100)

# Example 1A: WLR test with FH wights
x |> wlr(weight = fh(rho = 0, gamma = 0.5))
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "FH(rho=0, gamma=0.5)"
#> 
#> $estimate
#> [1] -8.982144
#> 
#> $se
#> [1] 2.598847
#> 
#> $z
#> [1] 3.456203
#> 
#> $info
#> [1] 6.622735
#> 
#> $info0
#> [1] 7.11092
#> 
x |> wlr(weight = fh(rho = 0, gamma = 0.5), return_variance = TRUE)
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "FH(rho=0, gamma=0.5)"
#> 
#> $estimate
#> [1] -8.982144
#> 
#> $se
#> [1] 2.598847
#> 
#> $z
#> [1] 3.456203
#> 
#> $info
#> [1] 6.622735
#> 
#> $info0
#> [1] 7.11092
#> 

# Example 1B: WLR test with MB wights
x |> wlr(weight = mb(delay = 4, w_max = 2))
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "MB(delay = 4, max_weight = 2)"
#> 
#> $estimate
#> [1] -17.35719
#> 
#> $se
#> [1] 6.009561
#> 
#> $z
#> [1] 2.888262
#> 
#> $info
#> [1] 35.45611
#> 
#> $info0
#> [1] 37.12714
#> 

# Example 1C: WLR test with early zero wights
x |> wlr(weight = early_zero(early_period = 4))
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "Xu 2017 with first 4 months of 0 weights"
#> 
#> $estimate
#> [1] -16.35958
#> 
#> $se
#> [1] 3.658775
#> 
#> $z
#> [1] 4.471326
#> 
#> $info
#> [1] 11.42857
#> 
#> $info0
#> [1] 14
#> 

# Example 1D
# For increased computational speed when running many WLR tests, you can
# pre-compute the counting_process() step first, and then pass the result of
# counting_process() directly to wlr()
x <- x |> counting_process(arm = "experimental")
x |> wlr(weight = fh(rho = 0, gamma = 1))
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "FH(rho=0, gamma=1)"
#> 
#> $estimate
#> [1] -6.044199
#> 
#> $se
#> [1] 1.645134
#> 
#> $z
#> [1] 3.673987
#> 
#> $info
#> [1] 2.737818
#> 
#> $info0
#> [1] 2.918227
#> 
x |> wlr(weight = mb(delay = 4, w_max = 2))
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "MB(delay = 4, max_weight = 2)"
#> 
#> $estimate
#> [1] -17.35719
#> 
#> $se
#> [1] 6.009561
#> 
#> $z
#> [1] 2.888262
#> 
#> $info
#> [1] 35.45611
#> 
#> $info0
#> [1] 37.12714
#> 
x |> wlr(weight = early_zero(early_period = 4))
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "Xu 2017 with first 4 months of 0 weights"
#> 
#> $estimate
#> [1] -16.35958
#> 
#> $se
#> [1] 3.658775
#> 
#> $z
#> [1] 4.471326
#> 
#> $info
#> [1] 11.42857
#> 
#> $info0
#> [1] 14
#> 

# ---------------------- #
#      Example 2         #
#  Use cumsum dataset    #
# ---------------------- #
x <- data.frame(treatment = ifelse(ex1_delayed_effect$trt == 1, "experimental", "control"),
                stratum = rep("All", nrow(ex1_delayed_effect)),
                tte = ex1_delayed_effect$month,
                event = ex1_delayed_effect$evntd)

# Users can specify the randomization ratio to calculate the statistical information under H0
x |> wlr(weight = fh(rho = 0, gamma = 0.5), ratio = 2)
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "FH(rho=0, gamma=0.5)"
#> 
#> $estimate
#> [1] -12.28665
#> 
#> $se
#> [1] 3.716574
#> 
#> $z
#> [1] 3.305908
#> 
#> $info
#> [1] 16.60727
#> 
#> $info0
#> [1] 15.27192
#> 

x |>
  counting_process(arm = "experimental") |>
  wlr(weight = fh(rho = 0, gamma = 0.5), ratio = 2)
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "FH(rho=0, gamma=0.5)"
#> 
#> $estimate
#> [1] -12.28665
#> 
#> $se
#> [1] 3.716574
#> 
#> $z
#> [1] 3.305908
#> 
#> $info
#> [1] 16.60727
#> 
#> $info0
#> [1] 15.27192
#> 

# If users don't provide the randomization ratio, we will calculate the emperical ratio
x |> wlr(weight = fh(rho = 0, gamma = 0.5))
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "FH(rho=0, gamma=0.5)"
#> 
#> $estimate
#> [1] -12.28665
#> 
#> $se
#> [1] 3.716574
#> 
#> $z
#> [1] 3.305908
#> 
#> $info
#> [1] 16.60727
#> 
#> $info0
#> [1] 15.31399
#> 

x |>
  counting_process(arm = "experimental") |>
  wlr(weight = fh(rho = 0, gamma = 0.5))
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "FH(rho=0, gamma=0.5)"
#> 
#> $estimate
#> [1] -12.28665
#> 
#> $se
#> [1] 3.716574
#> 
#> $z
#> [1] 3.305908
#> 
#> $info
#> [1] 16.60727
#> 
#> $info0
#> [1] 15.31399
#> 

# ---------------------- #
#      Example 3         #
#  Use formula           #
# ---------------------- #
library("survival")

# Unstratified design
x <- sim_pw_surv(n = 200) |> cut_data_by_event(100) |> as.data.frame()
colnames(x) <- c("tte", "evnt", "strtm", "trtmnt")
wlr(x, weight = fh(0, 0.5), formula = Surv(tte, evnt) ~ trtmnt)
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "FH(rho=0, gamma=0.5)"
#> 
#> $estimate
#> [1] -8.151712
#> 
#> $se
#> [1] 2.559737
#> 
#> $z
#> [1] 3.184589
#> 
#> $info
#> [1] 6.588311
#> 
#> $info0
#> [1] 6.955264
#> 

# Stratified design
x$strtm <- sample(c("s1", "s2"), size = nrow(x), replace = TRUE)
wlr(x, weight = fh(0, 0.5), formula = Surv(tte, evnt) ~ trtmnt + strata(strtm))
#> $method
#> [1] "WLR"
#> 
#> $parameter
#> [1] "FH(rho=0, gamma=0.5)"
#> 
#> $estimate
#> [1] -7.446813
#> 
#> $se
#> [1] 2.571142
#> 
#> $z
#> [1] 2.896306
#> 
#> $info
#> [1] 6.562729
#> 
#> $info0
#> [1] 6.925405
#> 
```
