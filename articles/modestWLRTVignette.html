<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="simtrial">
<title>Using the Magirr-Burman weights for testing • simtrial</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Using the Magirr-Burman weights for testing">
<meta property="og:description" content="simtrial">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">simtrial</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Merck/simtrial/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using the Magirr-Burman weights for testing</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Merck/simtrial/blob/HEAD/vignettes/modestWLRTVignette.Rmd" class="external-link"><code>vignettes/modestWLRTVignette.Rmd</code></a></small>
      <div class="d-none name"><code>modestWLRTVignette.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><span class="citation">Magirr and Burman (2019)</span> implemented a
modestly weighted logrank test with the following claim:</p>
<blockquote>
<p>Tests from this new class can be constructed to have high power under
a delayed-onset treatment effect scenario, as well as being almost as
efficient as the standard logrank test under proportional hazards.</p>
</blockquote>
<p>They have implemented this in the package <a href="https://github.com/dominicmagirr/modestWLRT" class="external-link">modestWLRT</a>. Since
the implementation is relatively straightforward, we have added this
functionality to the <code>simtrial</code> package and explain how to
use it here with the <code><a href="../reference/mb_weight.html">mb_weight()</a></code> function.</p>
<p>Packages used are as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://merck.github.io/simtrial/">simtrial</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulating-a-delayed-effect-example">Simulating a delayed effect example<a class="anchor" aria-label="anchor" href="#simulating-a-delayed-effect-example"></a>
</h2>
<p>First, we specify study duration, sample size and enrollment rates.
The enrollment rate is assumed constant during the enrollment period
until the targeted sample size is reached. For failure rates, we
consider the delayed treatment effect example of <span class="citation">Magirr and Burman (2019)</span>. The control group has
an exponential failure rate with a median of 15 months. For the initial
6 months, the underlying hazard ratio is one followed by a hazard ratio
of 0.7 thereafter. This differs from the <span class="citation">Magirr
and Burman (2019)</span> delayed effect assumptions only in that they
assume a hazard ratio of 0.5 after 6 months.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">studyDuration</span> <span class="op">&lt;-</span> <span class="fl">36</span></span>
<span><span class="va">sample_size</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">enroll_rate</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>duration <span class="op">=</span> <span class="fl">12</span>, rate <span class="op">=</span> <span class="fl">200</span> <span class="op">/</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">fail_rate</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">stratum</span>, <span class="op">~</span><span class="va">duration</span>, <span class="op">~</span><span class="va">fail_rate</span>, <span class="op">~</span><span class="va">hr</span>, <span class="op">~</span><span class="va">dropout_rate</span>,</span>
<span>  <span class="st">"All"</span>, <span class="fl">6</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">15</span>, <span class="fl">1</span>, <span class="fl">0</span>,</span>
<span>  <span class="st">"All"</span>, <span class="fl">36</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">15</span>, <span class="fl">.7</span>, <span class="fl">0</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we generate a single dataset with the above characteristics and
cut data for analysis at 36 months post start of enrollment. Then we
plot Kaplan-Meier curves for the resulting dataset (red curve for
experimental treatment, black for control):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">7789</span><span class="op">)</span></span>
<span><span class="va">xpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simfix2simpwsurv.html">simfix2simpwsurv</a></span><span class="op">(</span><span class="va">fail_rate</span><span class="op">)</span></span>
<span><span class="va">MBdelay</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_pw_surv.html">sim_pw_surv</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="va">sample_size</span>,</span>
<span>  stratum <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>stratum <span class="op">=</span> <span class="st">"All"</span>, p <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"control"</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"experimental"</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  enroll_rate <span class="op">=</span> <span class="va">enroll_rate</span>,</span>
<span>  fail_rate <span class="op">=</span> <span class="va">xpar</span><span class="op">$</span><span class="va">fail_rate</span>,</span>
<span>  dropout_rate <span class="op">=</span> <span class="va">xpar</span><span class="op">$</span><span class="va">dropout_rate</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/cut_data_by_date.html">cut_data_by_date</a></span><span class="op">(</span><span class="va">studyDuration</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">tte</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">treatment</span>, data <span class="op">=</span> <span class="va">MBdelay</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, mark <span class="op">=</span> <span class="st">"|"</span>, xaxt <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, xaxp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">36</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="modestWLRTVignette_files/figure-html/unnamed-chunk-4-1.png" width="720"></p>
</div>
<div class="section level2">
<h2 id="generalizing-the-magirr-burman-test">Generalizing the Magirr-Burman test<a class="anchor" aria-label="anchor" href="#generalizing-the-magirr-burman-test"></a>
</h2>
<p>Next, we consider the <span class="citation">Magirr (2021)</span>
extension of the modestly weighted logrank test (MWLRT) of <span class="citation">Magirr and Burman (2019)</span> where we have weights
as follows:</p>
<p><span class="math display">\[w(t, \tau, w_{\max}) =
\min\left(w_{\max},\left(\frac{1}{S(\min(t,\tau))}\right)\right).\]</span></p>
<p>This requires generating weights and then computing the test. We
begin with the default of <code>w_max=Inf</code> which corresponds to
the original <span class="citation">Magirr and Burman (2019)</span> test
and set the time until maximum weight <span class="math inline">\(\tau\)</span> with <code>delay = 6</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ZMB</span> <span class="op">&lt;-</span> <span class="va">MBdelay</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/counting_process.html">counting_process</a></span><span class="op">(</span>arm <span class="op">=</span> <span class="st">"experimental"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/mb_weight.html">mb_weight</a></span><span class="op">(</span>delay <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">o_minus_e</span> <span class="op">*</span> <span class="va">mb_weight</span><span class="op">)</span>, V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">var_o_minus_e</span> <span class="op">*</span> <span class="va">mb_weight</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, z <span class="op">=</span> <span class="va">S</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Compute p-value of modestly weighted logrank of Magirr-Burman</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">ZMB</span><span class="op">$</span><span class="va">z</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.1395378</span></span></code></pre></div>
<p>Now we set the maximum weight to be 2 as in <span class="citation">Magirr (2021)</span> and set the <code>delay=Inf</code>
so that the maximum weight begins at the observed median of the observed
combined treatment Kaplan-Meier curve.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ZMB</span> <span class="op">&lt;-</span> <span class="va">MBdelay</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/counting_process.html">counting_process</a></span><span class="op">(</span>arm <span class="op">=</span> <span class="st">"experimental"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/mb_weight.html">mb_weight</a></span><span class="op">(</span>delay <span class="op">=</span> <span class="cn">Inf</span>, w_max <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">o_minus_e</span> <span class="op">*</span> <span class="va">mb_weight</span><span class="op">)</span>, V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">var_o_minus_e</span> <span class="op">*</span> <span class="va">mb_weight</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, z <span class="op">=</span> <span class="va">S</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Compute p-value of modestly weighted logrank of Magirr-Burman</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">ZMB</span><span class="op">$</span><span class="va">z</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.1387672</span></span></code></pre></div>
<p>Another way this can be done is with a generalized Fleming-Harrington
test with</p>
<p><span class="math display">\[w(t; \rho, \gamma, w_{\max})=
\min((1-F(t))^\rho F(t)^\gamma, w_{\max})).\]</span></p>
<p>and let <span class="math inline">\(\gamma=0, \rho =
-1/2.\)</span></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w_max</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">Z_modified_FH</span> <span class="op">&lt;-</span> <span class="va">MBdelay</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/counting_process.html">counting_process</a></span><span class="op">(</span>arm <span class="op">=</span> <span class="st">"experimental"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">w_max</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">s</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">o_minus_e</span> <span class="op">*</span> <span class="va">w</span><span class="op">)</span>, V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">var_o_minus_e</span> <span class="op">*</span> <span class="va">w</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, z <span class="op">=</span> <span class="va">S</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Compute p-value of modestly weighted logrank of Magirr-Burman</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">Z_modified_FH</span><span class="op">$</span><span class="va">z</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.1387672</span></span></code></pre></div>
<div class="section level3">
<h3 id="freidlin-and-korn-strong-null-hypothesis-example">Freidlin and Korn strong null hypothesis example<a class="anchor" aria-label="anchor" href="#freidlin-and-korn-strong-null-hypothesis-example"></a>
</h3>
<p>For the next example, underlying survival is uniformly worse in the
experimental group compared to control throughout the planned follow-up.
This was presented by <span class="citation">Freidlin and Korn
(2019)</span>. For this case, we have a hazard ratio of 16 for 1/10 of 1
year (1.2 months), followed by a hazard ratio of 0.76 thereafter.</p>
<p>First, we specify study duration, sample size and enrollment rates.
The enrollment rate is assumed constant during the enrollment period
until the targeted sample size is reached. For failure rates, we
consider the delayed treatment effect example of <span class="citation">Magirr and Burman (2019)</span>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">studyDuration</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">sample_size</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span><span class="va">enrollDuration</span> <span class="op">&lt;-</span> <span class="fl">.0001</span></span>
<span><span class="va">enroll_rate</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>duration <span class="op">=</span> <span class="va">enrollDuration</span>, rate <span class="op">=</span> <span class="va">sample_size</span> <span class="op">/</span> <span class="va">enrollDuration</span><span class="op">)</span></span>
<span><span class="va">fail_rate</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  stratum <span class="op">=</span> <span class="st">"All"</span>,</span>
<span>  fail_rate <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>  dropout_rate <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  hr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span> <span class="op">/</span> <span class="fl">.25</span>, <span class="fl">.19</span> <span class="op">/</span> <span class="fl">.25</span><span class="op">)</span>,</span>
<span>  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">4.9</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we generate a single dataset with the above characteristics and
cut data for analysis at 5 years post start of enrollment. Then we plot
Kaplan-Meier curves for the resulting dataset (red curve for
experimental treatment, black for control):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">7783</span><span class="op">)</span></span>
<span><span class="va">xpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simfix2simpwsurv.html">simfix2simpwsurv</a></span><span class="op">(</span><span class="va">fail_rate</span><span class="op">)</span></span>
<span><span class="va">FHwn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_pw_surv.html">sim_pw_surv</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="va">sample_size</span>,</span>
<span>  stratum <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>stratum <span class="op">=</span> <span class="st">"All"</span>, p <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"control"</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"experimental"</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  enroll_rate <span class="op">=</span> <span class="va">enroll_rate</span>,</span>
<span>  fail_rate <span class="op">=</span> <span class="va">xpar</span><span class="op">$</span><span class="va">fail_rate</span>,</span>
<span>  dropout_rate <span class="op">=</span> <span class="va">xpar</span><span class="op">$</span><span class="va">dropout_rate</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/cut_data_by_date.html">cut_data_by_date</a></span><span class="op">(</span><span class="va">studyDuration</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">tte</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">treatment</span>, data <span class="op">=</span> <span class="va">FHwn</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, mark <span class="op">=</span> <span class="st">"|"</span>, xaxt <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, xaxp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">36</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="modestWLRTVignette_files/figure-html/unnamed-chunk-9-1.png" width="720"></p>
<p>We perform a logrank and weighted logrank tests as suggested for more
limited downweighting by follows:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xx</span> <span class="op">&lt;-</span> <span class="va">FHwn</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/counting_process.html">counting_process</a></span><span class="op">(</span>arm <span class="op">=</span> <span class="st">"experimental"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/fh_weight.html">fh_weight</a></span><span class="op">(</span>rho_gamma <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>rho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, return_corr <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">xx</span></span>
<span><span class="co">#&gt;   rho gamma         z        v1        v2        v3</span></span>
<span><span class="co">#&gt; 1   0     0  4.808526 1.0000000 0.8652115 0.9356769</span></span>
<span><span class="co">#&gt; 2   0     1 -3.204735 0.8652115 1.0000000 0.9580098</span></span>
<span><span class="co">#&gt; 3   1     1 -1.220445 0.9356769 0.9580098 1.0000000</span></span>
<span><span class="co">#&gt;              p</span></span>
<span><span class="co">#&gt; 1 0.9999992398</span></span>
<span><span class="co">#&gt; 2 0.0006759349</span></span>
<span><span class="co">#&gt; 3 0.1111481087</span></span></code></pre></div>
<p>Now for a MaxCombo test with the above component tests, we have
p-value of</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xx</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/pvalue_maxcombo.html">pvalue_maxcombo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.001256683</span></span></code></pre></div>
<p>Next, we consider the <span class="citation">Magirr and Burman
(2019)</span> modestly weighted logrank test with down-weighting
specified for the first 6 months but a maximum weight of 2. This
requires generating weights and then computing the test.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ZMB</span> <span class="op">&lt;-</span> <span class="va">FHwn</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/counting_process.html">counting_process</a></span><span class="op">(</span>arm <span class="op">=</span> <span class="st">"experimental"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/mb_weight.html">mb_weight</a></span><span class="op">(</span>delay <span class="op">=</span> <span class="fl">6</span>, w_max <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">o_minus_e</span> <span class="op">*</span> <span class="va">mb_weight</span><span class="op">)</span>, V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">var_o_minus_e</span> <span class="op">*</span> <span class="va">mb_weight</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, z <span class="op">=</span> <span class="va">S</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute p-value of modestly weighted logrank of Magirr-Burman</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">ZMB</span><span class="op">$</span><span class="va">z</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.920727</span></span></code></pre></div>
<p>Finally, we consider weighted logrank tests with less down-weighting.
Results are quite similar to the results with greater
down-weighting.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xx</span> <span class="op">&lt;-</span> <span class="va">FHwn</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/counting_process.html">counting_process</a></span><span class="op">(</span>arm <span class="op">=</span> <span class="st">"experimental"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/fh_weight.html">fh_weight</a></span><span class="op">(</span>rho_gamma <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>rho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">.5</span><span class="op">)</span>, gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.5</span>, <span class="fl">.5</span><span class="op">)</span><span class="op">)</span>, return_corr <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">xx</span></span>
<span><span class="co">#&gt;   rho gamma          z        v1        v2        v3</span></span>
<span><span class="co">#&gt; 1 0.0   0.0  4.8085258 1.0000000 0.9421013 0.9709414</span></span>
<span><span class="co">#&gt; 2 0.0   0.5 -0.6919228 0.9421013 1.0000000 0.9872682</span></span>
<span><span class="co">#&gt; 3 0.5   0.5  0.9278452 0.9709414 0.9872682 1.0000000</span></span>
<span><span class="co">#&gt;           p</span></span>
<span><span class="co">#&gt; 1 0.9999992</span></span>
<span><span class="co">#&gt; 2 0.2444929</span></span>
<span><span class="co">#&gt; 3 0.8232561</span></span></code></pre></div>
<p>Now for a MaxCombo test with the above component tests, we have
p-value of</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xx</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/pvalue_maxcombo.html">pvalue_maxcombo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.2915952</span></span></code></pre></div>
<p>Thus, with less down-weighting the MaxCombo test appears less
problematic. This is addressed at greater length in <span class="citation">Mukhopadhyay et al. (2022)</span>.</p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-FKNPH2019" class="csl-entry">
Freidlin, Boris, and Edward L Korn. 2019. <span>“Methods for
Accommodating Nonproportional Hazards in Clinical Trials: Ready for the
Primary Analysis?”</span> <em>Journal of Clinical Oncology</em> 37 (35):
3455–59.
</div>
<div id="ref-Magirr2021" class="csl-entry">
Magirr, Dominic. 2021. <span>“Non-Proportional Hazards in
Immuno-Oncology: Is an Old Perspective Needed?”</span>
<em>Pharmaceutical Statistics</em> 20 (3): 512–27.
</div>
<div id="ref-MagirrBurman" class="csl-entry">
Magirr, Dominic, and Carl-Fredrik Burman. 2019. <span>“Modestly Weighted
Logrank Tests.”</span> <em>Statistics in Medicine</em> 38 (20): 3782–90.
</div>
<div id="ref-Mukhopadhyay2022" class="csl-entry">
Mukhopadhyay, Pralay, Jiabu Ye, Keaven M Anderson, Satrajit
Roychoudhury, Eric H Rubin, Susan Halabi, and Richard J Chappell. 2022.
<span>“Log-Rank Test Vs MaxCombo and Difference in Restricted Mean
Survival Time Tests for Comparing Survival Under Nonproportional Hazards
in Immuno-Oncology Trials: A Systematic Review and
Meta-Analysis.”</span> <em>JAMA Oncology</em>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Keaven Anderson, Yilong Zhang, Yujie Zhao. Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7. <br>Copyright © 2023 Merck &amp; Co., Inc., Rahway, NJ, USA and its affiliates. All rights reserved.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p><span></span></p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
