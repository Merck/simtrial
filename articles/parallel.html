<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="simtrial">
<title>Simulating time-to-event trials in parallel • simtrial</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Simulating time-to-event trials in parallel">
<meta property="og:description" content="simtrial">
<meta property="og:image" content="https://merck.github.io/simtrial/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">simtrial</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.2.7</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Merck/simtrial/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Simulating time-to-event trials in parallel</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Merck/simtrial/blob/HEAD/vignettes/parallel.Rmd" class="external-link"><code>vignettes/parallel.Rmd</code></a></small>
      <div class="d-none name"><code>parallel.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette demonstrates the ability to implement
<code><a href="../reference/sim_fixed_n.html">sim_fixed_n()</a></code> using user-defined backends to parallelize
simulations. We will consider the backends supported by the <a href="https://future.futureverse.org/" class="external-link">future</a> framework.</p>
<p>The backends supported by the future package include:</p>
<ul>
<li>
<code>sequential</code> - default and non-parallel backend.</li>
<li>
<code>multisession</code> - uses multiple background R sessions on a
single machine.</li>
<li>
<code>multicore</code> - uses multiple forked R processes on a
single non-Windows machine outside of RStudio.</li>
<li>
<code>cluster</code> - supports external R sessions across multiple
machines.</li>
</ul>
<p>You can also choose other backend types supported by additional
future extension packages, such as the HPC job scheduler backends from
future.batchtools.</p>
<p>The function <code><a href="../reference/sim_fixed_n.html">sim_fixed_n()</a></code> provides a simulation
workflow for a two-arm trial with a single endpoint. We can vary the
parameters of the trial using different functions outlined in the
documentation. This function now provides users the opportunity to
implement their simulations using the previously described parallel
backends to accelerate the computation.</p>
</div>
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>Without specifying a backend, <code><a href="../reference/sim_fixed_n.html">sim_fixed_n()</a></code> will execute
sequentially. The sequential execution will run all <code>n_sim</code>
iterations within the same process or session of R. In order to execute
in parallel, we must define the environment prior to calling the
function. Setting your seed prior to calling the function will ensure
that the results are reproducible.</p>
<p>Suppose you want to investigate the duration of a trial under two
possible enrollments strategies. Both enrollments are piecewise, but
have varying durations and rates.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://merck.github.io/simtrial/">simtrial</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://doFuture.futureverse.org" class="external-link">doFuture</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span>
<span><span class="va">enroll_rate1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span>, duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">150</span>, <span class="fl">150</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">enroll_rate2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">30</span><span class="op">)</span>, duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">175</span>, <span class="fl">75</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rpwexp_enroll.html">rpwexp_enroll</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, enroll_rate <span class="op">=</span> <span class="va">enroll_rate1</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rpwexp_enroll.html">rpwexp_enroll</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, enroll_rate <span class="op">=</span> <span class="va">enroll_rate2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">x1</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palette.html" class="external-link">palette</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span>
<span>  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Piecewise enrollments"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"Time"</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"Enrollment"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">x2</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palette.html" class="external-link">palette</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span></span>
<span>  <span class="fl">250</span>, <span class="fl">1500</span>,</span>
<span>  legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Enrollment 1"</span>, <span class="st">"Enrollment 2"</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palette.html" class="external-link">palette</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/grDevices/palette.html" class="external-link">palette</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="parallel_files/figure-html/enrollments-1.png" width="576" style="display: block; margin: auto;"></p>
<p>We see that <em>Enrollment 2</em> enrolls individuals more quickly
than <em>Enrollment 1</em> at onset. Later, <em>Enrollment 1</em> will
outpace <em>Enrollment 2</em> before eventually being overtaken again.
As such, we want to consider how the duration of the study changes under
these enrollments.</p>
</div>
<div class="section level2">
<h2 id="the-sequential-run">The sequential run<a class="anchor" aria-label="anchor" href="#the-sequential-run"></a>
</h2>
<p>Naively, we can execute these simulations sequentially. We set the
target of a total enrollment of 3000 individuals with the trial ending
after observing 700 events. We use <code>timing_type = 2</code> to
return the correct trial duration.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">200</span></span>
<span></span>
<span><span class="va">start_sequential</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seq_result1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_fixed_n.html">sim_fixed_n</a></span><span class="op">(</span></span>
<span>  n_sim <span class="op">=</span> <span class="va">n_sim</span>,</span>
<span>  sample_size <span class="op">=</span> <span class="fl">3000</span>,</span>
<span>  target_event <span class="op">=</span> <span class="fl">700</span>,</span>
<span>  enroll_rate <span class="op">=</span> <span class="va">enroll_rate1</span>,</span>
<span>  timing_type <span class="op">=</span> <span class="fl">2</span> <span class="co"># Time until targeted event count achieved</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Backend uses sequential processing.</span></span>
<span></span>
<span><span class="va">seq_result2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_fixed_n.html">sim_fixed_n</a></span><span class="op">(</span></span>
<span>  n_sim <span class="op">=</span> <span class="va">n_sim</span>,</span>
<span>  sample_size <span class="op">=</span> <span class="fl">3000</span>,</span>
<span>  target_event <span class="op">=</span> <span class="fl">700</span>,</span>
<span>  enroll_rate <span class="op">=</span> <span class="va">enroll_rate2</span>,</span>
<span>  timing_type <span class="op">=</span> <span class="fl">2</span> <span class="co"># Time until targeted event count achieved</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Backend uses sequential processing.</span></span>
<span></span>
<span><span class="va">duration_sequential</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start_sequential</span></span></code></pre></div>
<p>A message automatically appears in the console that indicates what
backend is being used for processing.</p>
<p>The calls to <code><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time()</a></code> allow us to evaluate the
computation time of these procedures. This function provides three
outputs, we will focus on user and elapsed time. User time represents
the CPU time spent evaluating the function and elapsed time represents
the “wall clock” time spent by the end user waiting for the results.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">duration_sequential</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;  14.326   0.070   8.324</span></span></code></pre></div>
<p>We can see that the CPU time is 14.33 and the elapsed time is 8.32
seconds. These provide our baseline for the computation time.</p>
<p>As you may have anticipated, we see that for a lower number of
events, enrollment 2 has a shorter average duration of 99.8 over that of
enrollment 1, which is 131.2.</p>
<p>We also see that there is a distinction between the duration of the
study under the proposed enrollment strategies.</p>
</div>
<div class="section level2">
<h2 id="setting-up-a-parallel-backend">Setting up a parallel backend<a class="anchor" aria-label="anchor" href="#setting-up-a-parallel-backend"></a>
</h2>
<p>If we instead, wanted to run more simulations for each enrollment, we
can expect the time to run our simulations to increase. As we vary and
increase the number of parameter inputs that we consider, we expect the
simulation process to continue to increase in duration. To help combat
the growing computational burden, we can run these simulations in
parallel using the <code>multisession</code> backend available to us in
<code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code>.</p>
<p>We can adjust the default number of cores with the function
<code><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">parallelly::availableCores()</a></code>. The multisession backend will
automatically use all available cores by default, but here we will use
two. To initialize our backend, we change our plan.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="execution-in-parallel">Execution in parallel<a class="anchor" aria-label="anchor" href="#execution-in-parallel"></a>
</h2>
<p>Once we have configured the backend details, we can execute the same
code as before to automatically distribute the <code>n_sim</code>
simulations across the available cores.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">start_sequential</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seq_result1m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_fixed_n.html">sim_fixed_n</a></span><span class="op">(</span></span>
<span>  n_sim <span class="op">=</span> <span class="va">n_sim</span>,</span>
<span>  sample_size <span class="op">=</span> <span class="fl">3000</span>,</span>
<span>  target_event <span class="op">=</span> <span class="fl">700</span>,</span>
<span>  enroll_rate <span class="op">=</span> <span class="va">enroll_rate1</span>,</span>
<span>  timing_type <span class="op">=</span> <span class="fl">2</span> <span class="co"># Time until targeted event count achieved</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Using 2 cores with backend multisession</span></span>
<span></span>
<span><span class="va">seq_result2m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_fixed_n.html">sim_fixed_n</a></span><span class="op">(</span></span>
<span>  n_sim <span class="op">=</span> <span class="va">n_sim</span>,</span>
<span>  sample_size <span class="op">=</span> <span class="fl">3000</span>,</span>
<span>  target_event <span class="op">=</span> <span class="fl">700</span>,</span>
<span>  enroll_rate <span class="op">=</span> <span class="va">enroll_rate2</span>,</span>
<span>  timing_type <span class="op">=</span> <span class="fl">2</span> <span class="co"># Time until targeted event count achieved</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Using 2 cores with backend multisession</span></span>
<span></span>
<span><span class="va">duration_sequential</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html" class="external-link">proc.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start_sequential</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">duration_sequential</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.481   0.005   8.013</span></span></code></pre></div>
<p>We can see that the CPU time is 0.48 and the elapsed time is 8.01
seconds. The user time here appears to be drastically reduced because of
how R keeps track of time; the time used by the parent process and not
the children processes are reported for the user time. Therefore, we
compare the elapsed time to see the real-world impact of the
parallelization.</p>
<p>To change the implementation back to a sequential backend, we simply
use what is below.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p>We can also verify that the simulation results are identical because
of setting a seed and that the backend type will not affect the results.
Below, it is clear that the results from our sequential and multisession
backends match completely.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">seq_result1</span> <span class="op">!=</span> <span class="va">seq_result1m</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">seq_result2</span> <span class="op">!=</span> <span class="va">seq_result2m</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p><em>Note:</em> A parallel implementation may not always be faster
than a serial implementation. If there is substantial overhead
associated with executing in parallel, sequential evaluation may be
faster. For a low number of simulations or available cores, it may be
preferable to continue computation in serial rather than parallel. We
leave it to the end user to determine this difference based on the
resources available to them.</p>
</div>
<div class="section level2">
<h2 id="a-nested-parallel-example">A nested parallel example<a class="anchor" aria-label="anchor" href="#a-nested-parallel-example"></a>
</h2>
<p>We provide an additional example using a nested parallel structure
for users with more extensive resources, such as high-performance
computing clusters, available to them. Because these resources are not
commonly available, we will not execute the below code herein. Consider
that you have two accessible nodes, each with three cores (shown in the
diagram below).</p>
<div class="figure" style="text-align: center">
<img src="schema.png" alt="Available resource schematic." width="90%"><p class="caption">
Available resource schematic.
</p>
</div>
<p>Ideally, all available resources will be used when executing the
simulations. To do this, we need to correctly define our backend using
<code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan()</a></code> and run the same code as previously. The different
structures, or topologies, for a backend can be changed with a more in
depth explanation given in the <a href="https://future.futureverse.org/articles/future-3-topologies.html" class="external-link">future
topologies vignette</a>. Our below example follows closely their
example.</p>
<p>In our below snippet, we consider the two nodes named <code>n1</code>
and <code>n2</code> and create a function to select the number of cores
to use on those named nodes. While trivial here, a courteous user of
shared machines would specify fewer than all available cores and can do
such using a modification of the below code. We then implement our
backend using a list that follows the hierarchy of the available
resources.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n1"</span>, <span class="st">"n2"</span><span class="op">)</span></span>
<span><span class="va">custom_cores</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html" class="external-link">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"nodename"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="st">"n1"</span> <span class="op">=</span> <span class="fl">3L</span>, <span class="co"># Modify here for number of cores on node1</span></span>
<span>    <span class="st">"n2"</span> <span class="op">=</span> <span class="fl">3L</span>, <span class="co"># Modify here for number of cores on node2</span></span>
<span>    <span class="co">## Default:</span></span>
<span>    <span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">availableCores</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://future.futureverse.org/reference/tweak.html" class="external-link">tweak</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="va">nodes</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://future.futureverse.org/reference/tweak.html" class="external-link">tweak</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="va">custom_cores</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The function <code><a href="https://future.futureverse.org/reference/tweak.html" class="external-link">tweak()</a></code> is necessary to override the
inherent protection of nested parallelism, meant to help avoid
overloading one’s resources by errantly starting too many processes.
Because of the need to tweak backends, the message echoed to the console
for nested backends reflects the highest level of the nested
hierarchy.</p>
<p>With the backend in place, we then can run the identical code from
before using all available resources and return the same results as
before.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">enroll_rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">enroll_rate1</span>, <span class="va">enroll_rate2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seq_resultc</span> <span class="op">&lt;-</span> <span class="fu">foreach</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span><span class="op">(</span></span>
<span>  i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,</span>
<span>  .combine <span class="op">=</span> <span class="st">"list"</span>,</span>
<span>  .options.future <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://doFuture.futureverse.org/reference/grapes-dofuture-grapes.html" class="external-link">%dofuture%</a></span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/sim_fixed_n.html">sim_fixed_n</a></span><span class="op">(</span></span>
<span>    n_sim <span class="op">=</span> <span class="va">n_sim</span>,</span>
<span>    sample_size <span class="op">=</span> <span class="fl">3000</span>,</span>
<span>    target_event <span class="op">=</span> <span class="fl">700</span>,</span>
<span>    enroll_rate <span class="op">=</span> <span class="va">enroll_rates</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    timing_type <span class="op">=</span> <span class="fl">2</span> <span class="co"># Time until targeted event count achieved</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then, we reset the <code>plan</code> to sequential to avoid
accidentally continuing to execute later calls within these
resources.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Keaven Anderson, Yilong Zhang, Yujie Zhao. Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7. <br>Copyright © 2024 Merck &amp; Co., Inc., Rahway, NJ, USA and its affiliates. All rights reserved.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p><span></span></p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
