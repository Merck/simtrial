---
title: "Profiling `simfix`"
author: "Jianxiao Yang"
output:
  html_document:
    code_folding: hide
    toc: TRUE
    toc_float: TRUE
    number_sections: true
---

```{r}
sessionInfo()
```

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(simtrial)
library(knitr)
library(tibble)
library(dplyr)
library(gt)
library(ggplot2)
library(doParallel)
devtools::load_all()
```

# Data

In this example, we consider

- 2 strata
- 2 periods in enrollments
- 4 periods in failure rates of the control arm per stratum
- 4 periods in failure rates of the experimental arm per stratum
- 4 periods in dropout rates of the control arm per stratum
- 4 periods in dropout rates of the experimental arm per stratum

```{r data}
# 2 strata: Biomarker negative (50% of population) + Biomarker positive (50% of population); 
strata <- tibble(Stratum = c("Biomarker Negative", "Biomarker Positive"), p = c(.5, .5))

block <- c(rep("Control", 2), rep("Experimental", 2))

# enrollment over 1 year, with ramp-up over first 6 months
enrollRates <- tibble(rate = c(2, 4, 6, 8) * 11.1, 
                      duration = c(2, 2, 2, 6))

# failure rate:
# - biomarker negative: control is exponential with median of 12 months; experimental has HR = 1.2 for 4 months followed by HR=.65
# - biomarker positive: control is exponential with median of 12 months; experimental has HR = .9 for 4 months followed by HR=.4)
failRates <- tibble(
  Stratum = c(rep("Biomarker Negative", 3), rep("Biomarker Positive", 3)),
  period = c(1, 1:2, 1, 1:2),
  Treatment = rep(c("Control", rep("Experimental", 2)), 2),
  duration = c(12, 4, 8, 12, 4, 8), 
  rate = c(log(2)/12, log(2)/12*1.2, log(2)/12*0.65, log(2)/12, log(2)/12*0.9, log(2)/12*0.4)
)

# dropout rate
dropoutRates <- tibble(
  Stratum = c(rep("Biomarker Negative", 4), rep("Biomarker Positive", 4)),
  period = rep(1:2, 4),
  Treatment = rep(c(rep("Control", 2), rep("Experimental", 2)), 2),
  duration = rep(c(3, 1), 4),
  rate = rep(c(.001, .001), 4)
)

# Create failRatesAll for simfix
failRatesAll <- failRates[failRates$Treatment == "Experimental", ]
failRatesAll$dropoutRate <- dropoutRates[dropoutRates$Treatment == "Experimental", ]$rate
failRatesAll$hr <- c(rep(0.6, 2), rep(0.9, 2))
failRatesAll <- failRatesAll %>%
  mutate(failRate = rate/hr) %>%
  select("Stratum", "duration", "failRate", "hr", "dropoutRate")
rg <- tibble(rho = 0, gamma = 0)
```

# Runtime of `simfix` across different number of simulations
```{r}
sampleSize = 800 # Trial sample size
targetEvents = 350 # Targeted events at analysis
totalDuration = 30 # Planned trial duration

nitr <- 1
n_sims <- c(1, 10, 100)
times <- rep(0, length(n_sims))
times_new <- rep(0, length(n_sims))
for (itr in 1:nitr) {
  for (i in 1:length(n_sims)) {
    start <- Sys.time()
    simtrial:::simfix_(
      nsim = n_sims[i], # Number of simulations
      sampleSize = sampleSize, # Trial sample size
      targetEvents = targetEvents, # Targeted events at analysis
      strata = strata, # Study strata
      enrollRates = enrollRates, # Enrollment rates
      failRates = failRatesAll, # Failure rates
      totalDuration = totalDuration, # Planned trial duration
      block = block, # Block for treatment
      timingType = 1:5, # Use all possible data cutoff methods
      rg = rg # FH test(s) to use; in this case, logrank
    )  
    times[i] <- times[i] + difftime(Sys.time(), start, units = "sec")[[1]]
    
    start <- Sys.time()
    simtrial::simfix(
      nsim = n_sims[i], # Number of simulations
      sampleSize = sampleSize, # Trial sample size
      targetEvents = targetEvents, # Targeted events at analysis
      strata = strata, # Study strata
      enrollRates = enrollRates, # Enrollment rates
      failRates = failRatesAll, # Failure rates
      totalDuration = totalDuration, # Planned trial duration
      block = block, # Block for treatment
      timingType = 1:5, # Use all possible data cutoff methods
      rg = rg # FH test(s) to use; in this case, logrank
    )  
    times_new[i] <- times_new[i] + difftime(Sys.time(), start, units = "sec")[[1]]
  }
}

tb_times <- t(data.frame(nsims = as.character(sort(n_sims)),
                         simfix = times/nitr,
                         simfixNew = times_new/nitr))
rownames(tb_times) <- c("Number of simulations", "Old simfix", "New simfix")
kable(tb_times)
```

We notice a quasi-linear relationship between the run time of `simfix` and the value of `nsim` (the number of simulations).


# Profile one simulation

```{r functions}
nstrata <- nrow(strata)
doAnalysis <- function(d,rg,nstrata){
  if (nrow(rg)==1) {
    Z = tibble::tibble(Z=(d %>%
                            simtrial::tensurv(txval="Experimental") %>%
                            simtrial::tenFH(rg=rg))$Z)
  } else {
    Z = d %>%
      simtrial::tensurv(txval="Experimental") %>%
      simtrial::tenFHcorr(rg=rg,corr=TRUE)
  }
    r <- cbind(tibble::tibble(Events = sum(d$event),
                              lnhr = as.numeric(ifelse(nstrata>1,
                                                       survival::coxph(survival::Surv(tte,event)~
                                                                         (Treatment=="Experimental")+
                                                     survival::strata(Stratum),data=d)$coefficients,
                                   survival::coxph(survival::Surv(tte,event)~
                                                     (Treatment=="Experimental"),data=d)$coefficients))
                           ),
               Z
    )
  r
}

# compute minimum planned follow-up time
minFollow <- max(0,totalDuration - sum(enrollRates$duration))
# put failure rates into simPWSurv format
xx <- simfix2simPWSurv(failRatesAll)
fr <- xx$failRates
dr <- xx$dropoutRates

# Benchmark simfix
mbm_simfix <- function(n_iter = 20,
                       times_iter = rep(0, 6),
                       timingType,
                       useSimfixNew = TRUE,
                       nstrata,
                       minFollow,
                       fr,
                       dr,
                       sampleSize = 800,
                       targetEvents = 350,
                       totalDuration = 30) {
  for (i in 1:n_iter) {
  
    if (useSimfixNew) {
      # simPWSurvNew
      s1 <- Sys.time()
      sim <- simtrial::simPWSurv(n = sampleSize,
                                   strata = strata,
                                   enrollRates = enrollRates,
                                   failRates = fr,
                                   dropoutRates = dr,
                                   block = block)
      times_iter[1] = times_iter[1] + Sys.time() - s1
    } else {
      # simPWSurv
      s1 <- Sys.time()
      sim <- simtrial:::simPWSurv_(n = sampleSize,
                                   strata = strata,
                                   enrollRates = enrollRates,
                                   failRates = fr,
                                   dropoutRates = dr,
                                   block = block)
      times_iter[1] = times_iter[1] + Sys.time() - s1
    }

    # getCutDateForCount
    s2 <- Sys.time()
    # study date that targeted event rate achieved
    tedate <- sim %>% getCutDateForCount(targetEvents)
    times_iter[2] = times_iter[2] + Sys.time() - s2
  
    # Compute tests
    s3 <- Sys.time()
    # study data that targeted minimum follow-up achieved
    tmfdate <- max(sim$enrollTime) + minFollow
    # Compute tests for all specified cutoff options
    r1 <- NULL ; r2 <- NULL; r3 <- NULL;
    tests <- rep(FALSE,3)
    ## Total planned trial duration or max of this and targeted events
    if (max(1 == timingType)) tests[1] <- TRUE # planned duration cutoff
    if (max(2 == timingType)) tests[2] <- TRUE # targeted events cutoff
    if (max(3 == timingType)) tests[3] <- TRUE # minimum follow-up duration target
    if (max(4 == timingType)){ # max of planned duration, targeted events
      if (tedate > totalDuration){
        tests[2] <- TRUE
      }else tests[1] <- TRUE
    }
    if (max(5 == timingType)){ # max of minimum follow-up, targeted events
      if (tedate > tmfdate){
        tests[2] <- TRUE
      }else tests[3] <- TRUE
    }
    times_iter[3] = times_iter[3] + Sys.time() - s3
  
    # cutData
    s4 <- Sys.time()
      if (tests[1]){ # Total duration cutoff
        d1 <- sim %>% cutData(totalDuration)
        # r1 <- d %>% doAnalysis(rg,nstrata)
      }
      if (tests[2]){ # targeted events cutoff
        d2 <- sim %>% cutData(tedate)
        # r2 <- d %>% doAnalysis(rg,nstrata)
      }
      if (tests[3]){ # minimum follow-up cutoff
        d3 <- sim %>% cutData(tmfdate)
        # r3 <- d %>% doAnalysis(rg,nstrata)
      }
    times_iter[4] = times_iter[4] + Sys.time() - s4
  
    # doAnalysis
    s5 <- Sys.time()
      if (tests[1]){ # Total duration cutoff
        # d <- sim %>% cutData(totalDuration)
        r1 <- d1 %>% doAnalysis(rg,nstrata)
      }
      if (tests[2]){ # targeted events cutoff
        # d <- sim %>% cutData(tedate)
        r2 <- d2 %>% doAnalysis(rg,nstrata)
      }
      if (tests[3]){ # minimum follow-up cutoff
        # d <- sim %>% cutData(tmfdate)
        r3 <- d3 %>% doAnalysis(rg,nstrata)
      }
    times_iter[5] = times_iter[5] + Sys.time() - s5
  
    # Compute addit
    s6 <- Sys.time()
      addit <- NULL
      # planned duration cutoff
      if (max(1 == timingType)) addit <- rbind(addit,
                                               r1 %>% mutate(cut="Planned duration",Duration=totalDuration))
      # targeted events cutoff
      if (max(2 == timingType)) addit <- rbind(addit, r2 %>% mutate(cut="Targeted events",Duration=tedate))
      # minimum follow-up duration target
      if (max(3 == timingType)) addit <- rbind(addit, r3 %>% mutate(cut="Minimum follow-up",Duration=tmfdate))
      if (max(4 == timingType)){ # max of planned duration, targeted events
        if (tedate > totalDuration){
          addit <- rbind(addit, r2 %>% mutate(cut="Max(planned duration, event cut)",Duration=tedate))
        }else addit <- rbind(addit, r1 %>% mutate(cut="Max(planned duration, event cut)",Duration=totalDuration))
      }
      if (max(5 == timingType)){ # max of minimum follow-up, targeted events
        if (tedate > tmfdate){
          addit <- rbind(addit, r2 %>% mutate(cut="Max(min follow-up, event cut)",Duration=tedate))
        }else addit <- rbind(addit, r3 %>% mutate(cut="Max(min follow-up, event cut)",Duration=tmfdate))
      }
    times_iter[6] = times_iter[6] + Sys.time() - s6
  }
  
  if (useSimfixNew) {
    evals <- c("New simPWSurv",
              "getCutDataForCount",
              "compute tests",
              "cutData",
              "doAnalysis",
              "compute addit",
              "All")
  } else {
    evals <- c("Old simPWSurv",
              "getCutDataForCount",
              "compute tests",
              "cutData",
              "doAnalysis",
              "compute addit",
              "All")
  }
  return (data.frame(eval = evals,
                     time = c(times_iter / n_iter, sum(times_iter) / n_iter),
                     percent = c(round(times_iter / sum(times_iter) * 100, 2), 100)))
}


sim <- simtrial::simPWSurv(n = sampleSize,
                             strata = strata,
                             enrollRates = enrollRates,
                             failRates = fr,
                             dropoutRates = dr,
                             block = block)
# study date that targeted event rate achieved
tedate <- sim %>% getCutDateForCount(targetEvents)
# study data that targeted minimum follow-up achieved
tmfdate <- max(sim$enrollTime) + minFollow

d1 <- sim %>% cutData(totalDuration)
d2 <- sim %>% cutData(tedate)
d3 <- sim %>% cutData(tmfdate)

# Benchmark doAnalysis
mbm_doAnalysis <- function(n_iter = 20,
                           times_do = rep(0, 4),
                           d,
                           rg,
                           nstrata) {
  for (i in 1:n_iter) {
  
    # tensurv
    s1 <- Sys.time()
    d11 <- d %>% simtrial::tensurv(txval="Experimental")
    times_do[1] = times_do[1] + Sys.time() - s1
  
    # tenFH
    s2 <- Sys.time()
    d12 <- d11 %>% simtrial::tenFH(rg=rg)
    times_do[2] = times_do[2] + Sys.time() - s2
  
    # Z tibble
    s3 <- Sys.time()
    Z = tibble::tibble(Z=d12$Z)
    times_do[3] = times_do[3] + Sys.time() - s3
  
    # cbind
    s4 <- Sys.time()
    r <- cbind(tibble::tibble(Events = sum(d$event),
                              lnhr = as.numeric(ifelse(nstrata>1,
                                                       survival::coxph(survival::Surv(tte,event)~
                                                                         (Treatment=="Experimental")+
                                                     survival::strata(Stratum),data=d)$coefficients,
                                   survival::coxph(survival::Surv(tte,event)~
                                                     (Treatment=="Experimental"),data=d)$coefficients))
                           ),
               Z
    )
    times_do[4] = times_do[4] + Sys.time() - s4
  }
  return (data.frame(eval = c("tensurv",
                              "tenFH",
                              "Z",
                              "r",
                              "All"),
                     time = c(times_do / n_iter, sum(times_do) / n_iter),
                     percent = c(round(times_do / sum(times_do) * 100, 2), 100)))
}

# Benchmark tensurv
mbm_tensurv <- function(n_iter = 20,
                        times_tensurv = rep(0, 9),
                        d,
                        checkTie = FALSE,
                        useBaseR = FALSE,
                        txval="Experimental") {
  options(dplyr.summarise.inform = FALSE)

  for (i in 1:n_iter) {
    s1 <- Sys.time()
    x1 <- d %>% group_by(Stratum) %>% arrange(desc(tte))
    times_tensurv[1] = times_tensurv[1] + Sys.time() - s1
    
    s2 <- Sys.time()
    x2 <- x1 %>% mutate(one=1,
                        atrisk=cumsum(one),
                        txatrisk=cumsum(Treatment==txval)) 
    times_tensurv[2] = times_tensurv[2] + Sys.time() - s2
    
    if (checkTie) {
      s3 <- Sys.time()
      noTie = length(x2$tte[which(x2$Treatment==txval)])-length(unique(x2$tte[which(x2$Treatment==txval)])) == 0
      if (noTie) {
        x3 <- x2 %>%
              group_by(Stratum) %>%
              mutate(txevents=(Treatment==txval)*event) %>%
              rename(events=event) %>%
              select(-one)
      } else {
        x3 <- x2 %>%
              # Handling ties using Breslow's method
              group_by(Stratum, mtte=desc(tte)) %>%
              dplyr::summarise(events=sum(event),
                               txevents=sum((Treatment==txval)*event),
                               tte=first(tte),
                               atrisk=max(atrisk),
                               txatrisk=max(txatrisk))
      }
      times_tensurv[3] = times_tensurv[3] + Sys.time() - s3
    } else {
      s3 <- Sys.time()
      x3 <- x2 %>%
            # Handling ties using Breslow's method
            group_by(Stratum, mtte=desc(tte)) %>%
            dplyr::summarise(events=sum(event),
                             txevents=sum((Treatment==txval)*event),
                             tte=first(tte),
                             atrisk=max(atrisk),
                             txatrisk=max(txatrisk))
      times_tensurv[3] = times_tensurv[3] + Sys.time() - s3
    }

    if (useBaseR) {
      s4 <- Sys.time()
      x4 <- x3[which(x3$events > 0 & x3$atrisk > x3$txatrisk & x3$txatrisk > 0),]
      times_tensurv[4] = times_tensurv[4] + Sys.time() - s4
    } else {
      s4 <- Sys.time()
      x4 <- x3 %>%
            # Keep calculation for observed time with at least one event, at least one subject is
            # at risk in both treatment group and control group.
            filter(events>0, atrisk-txatrisk>0, txatrisk>0)
      times_tensurv[4] = times_tensurv[4] + Sys.time() - s4
    }

    if (checkTie) {
      s5 <- Sys.time()
      if (noTie) {
        x5 <- x4
      } else {
        x5 <- x4 %>%
              select(-mtte) 
      }
      times_tensurv[5] = times_tensurv[5] + Sys.time() - s5
    } else {
      s5 <- Sys.time()
      x5 <- x4 %>%
        select(-mtte) 
      times_tensurv[5] = times_tensurv[5] + Sys.time() - s5
    }
    
    s6 <- Sys.time()
    x6 <- x5 %>%
          mutate(s=1-events/atrisk) 
    times_tensurv[6] = times_tensurv[6] + Sys.time() - s6
    
    s7 <- Sys.time()
    x7 <- x6 %>%
          arrange(Stratum, tte) 
    times_tensurv[7] = times_tensurv[7] + Sys.time() - s7
    
    s8 <- Sys.time()
    x8 <- x7 %>%
          group_by(Stratum) %>%
          mutate(S=lag(cumprod(s), default=1),               # left continuous Kaplan-Meier Estimator
                 OminusE=txevents-txatrisk/atrisk*events,    #  Observed events minus Expected events in treatment group
                 Var=(atrisk-txatrisk)*txatrisk*events*(atrisk-events)/atrisk^2/(atrisk-1)) 
    times_tensurv[8] = times_tensurv[8] + Sys.time() - s8
    
    s9 <- Sys.time()
    x9 <- x8 %>% #Variance of OminusE
                 select(-s)
    times_tensurv[9] = times_tensurv[9] + Sys.time() - s9
  }
  
  return (data.frame(eval = c("group_by arrange",
                            "mutate",
                            "group_by summarise",
                            "filter",
                            "select",
                            "mutate",
                            "arrange",
                            "group_by mutate",
                            "select",
                            "All"),
                   time = c(times_tensurv / n_iter, sum(times_tensurv) / n_iter),
                   percent = c(round(times_tensurv / sum(times_tensurv) * 100, 2), 100)))
}
```

## `timingType = 1`

### `simfix`
```{r prof_simfix1}
times_simfix1 <- mbm_simfix(timingType = 1,
                            useSimfixNew = FALSE,
                            nstrata = nstrata,
                            minFollow = minFollow,
                            fr = fr,
                            dr = dr)

kable(times_simfix1)
```

### `simfix` with new `simPWSurv`
```{r prof_simfixNew1}
times_simfixNew1 <- mbm_simfix(timingType = 1,
                            nstrata = nstrata,
                            minFollow = minFollow,
                            fr = fr,
                            dr = dr)

kable(times_simfixNew1)
```

### `doAnalysis`
```{r prof_doAnalysis1}
times_do1 <- mbm_doAnalysis(d = d1,
                            rg = rg,
                            nstrata = nstrata)

kable(times_do1)
```

### `tensurv`
```{r prof_tensurv1}
times_tensurv1 <- mbm_tensurv(d = d1)
kable(times_tensurv1)
```

### `tensurv` with tie-check
```{r prof_tensurvNew1}
times_tensurvNew1 <- mbm_tensurv(d = d1, checkTie = TRUE)
kable(times_tensurvNew1)
```


## `timingType = 2`

### `simfix`
```{r prof_simfix2}
times_simfix2 <- mbm_simfix(timingType = 2,
                            useSimfixNew = FALSE,
                            nstrata = nstrata,
                            minFollow = minFollow,
                            fr = fr,
                            dr = dr)

kable(times_simfix2)
```

### `simfix` with new `simPWSurv`
```{r prof_simfixNew2}
times_simfixNew2 <- mbm_simfix(timingType = 2,
                            nstrata = nstrata,
                            minFollow = minFollow,
                            fr = fr,
                            dr = dr)

kable(times_simfixNew2)
```

### `doAnalysis`
```{r prof_doAnalysis2}
times_do2 <- mbm_doAnalysis(d = d2,
                            rg = rg,
                            nstrata = nstrata)

kable(times_do2)
```

### `tensurv`
```{r prof_tensurv2}
times_tensurv2 <- mbm_tensurv(d = d2)
kable(times_tensurv2)
```

### `tensurv` with tie-check
```{r prof_tensurvNew2}
times_tensurvNew2 <- mbm_tensurv(d = d2, checkTie = TRUE)
kable(times_tensurvNew2)
```

## `timingType = 3`

### `simfix`
```{r prof_simfix3}
times_simfix3 <- mbm_simfix(timingType = 3,
                            useSimfixNew = FALSE,
                            nstrata = nstrata,
                            minFollow = minFollow,
                            fr = fr,
                            dr = dr)

kable(times_simfix3)
```

### `simfix` with new `simPWSurv`
```{r prof_simfixNew3}
times_simfixNew3 <- mbm_simfix(timingType = 3,
                            nstrata = nstrata,
                            minFollow = minFollow,
                            fr = fr,
                            dr = dr)

kable(times_simfixNew3)
```

### `doAnalysis`
```{r prof_doAnalysis3}
times_do3 <- mbm_doAnalysis(d = d3,
                            rg = rg,
                            nstrata = nstrata)

kable(times_do3)
```

### `tensurv`
```{r prof_tensurv3}
times_tensurv3 <- mbm_tensurv(d = d3)
kable(times_tensurv3)
```

### `tensurv` with tie-check
```{r prof_tensurvNew3}
times_tensurvNew3 <- mbm_tensurv(d = d3, checkTie = TRUE)
kable(times_tensurvNew3)
```

**Summary**

We focus on three cases when `timingType` is a scalar (1, 2, or 3).

  - Before optimizing `simPWSurv`, `simPWSurv` takes $50\%$ of the runtime in one simulation in all three cases.

  - With a more efficient `simPWSurv`, `simPWSurv` is no longer the main bottleneck of `simfix`, while `doAnalysis` takes $50\%$ to $60\%$ of the runtime in one simulation.

  - Further benchmark `doAnalysis`, we can see `tensurv` takes almost $80\%$ of the runtime of `doAnalysis`.
