---
title: "Parallel computing in `simfix`"
author: "Jianxiao Yang"
output:
  html_document:
    code_folding: hide
    toc: TRUE
    toc_float: TRUE
    number_sections: true
---

```{r}
sessionInfo()
```

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(simtrial)
library(knitr)
library(tibble)
library(dplyr)
library(gt)
library(ggplot2)
library(profvis)
library(bench)
library(microbenchmark)
library(PWEALL)
library(parallel)
library(doParallel)
devtools::load_all()
```

# Data

In this example, we consider

- 2 strata
- 2 periods in enrollments
- 4 periods in failure rates of the control arm per stratum
- 4 periods in failure rates of the experimental arm per stratum
- 4 periods in dropout rates of the control arm per stratum
- 4 periods in dropout rates of the experimental arm per stratum

```{r data}
# 2 strata: Biomarker negative (50% of population) + Biomarker positive (50% of population); 
enrollStrata <- tibble(Stratum = c("Biomarker Negative", "Biomarker Positive"), p = c(.5, .5))

block <- c(rep("Control", 2), rep("Experimental", 2))

# enrollment over 1 year, with ramp-up over first 6 months
enrollRates <- tibble(rate = c(9, 2), duration = c(6, 6))

# failure rate:
# - biomarker negative: control is exponential with median of 12 months; experimental has HR = 1.2 for 4 months followed by HR=.65
# - biomarker positive: control is exponential with median of 12 months; experimental has HR = .9 for 4 months followed by HR=.4)
failRates <- tibble(
  Stratum = c(rep("Biomarker Negative", 3), rep("Biomarker Positive", 3)),
  period = c(1, 1:2, 1, 1:2),
  Treatment = rep(c("Control", rep("Experimental", 2)), 2),
  duration = c(12, 4, 8, 12, 4, 8), 
  rate = c(log(2)/12, log(2)/12*1.2, log(2)/12*0.65, log(2)/12, log(2)/12*0.9, log(2)/12*0.4)
)

# dropout rate
dropoutRates <- tibble(
  Stratum = c(rep("Biomarker Negative", 4), rep("Biomarker Positive", 4)),
  period = rep(1:2, 4),
  Treatment = rep(c(rep("Control", 2), rep("Experimental", 2)), 2),
  duration = rep(c(3, 1), 4),
  rate = rep(c(.001, .001), 4)
)

# Create failRatesAll for simfix
failRatesAll <- failRates[failRates$Treatment == "Experimental", ]
failRatesAll$dropoutRate <- dropoutRates[dropoutRates$Treatment == "Experimental", ]$rate
failRatesAll$hr <- c(rep(0.6, 2), rep(0.9, 2))
failRatesAll <- failRatesAll %>%
  mutate(failRate = rate/hr) %>%
  select("Stratum", "duration", "failRate", "hr", "dropoutRate")
rg <- tibble(rho = 0, gamma = 0)
```

# Functions for running simfix and simfixNew in serial and in parallel
```{r runSimfix}
runSimfix <- function(nsim = 1000, # Number of simulations
                      sampleSize = 800, # Trial sample size
                      targetEvents = 350, # Targeted events at analysis
                      totalDuration = 30, # Planned trial duration
                      timingType = 1:5, # Use all possible data cutoff methods
                      cores = c(1, 2, 4, 6, 8)
                      ) {
  times <- rep(0, length(cores))

  # In serial
  registerDoParallel(1)
  start <- Sys.time()
  s <- simfix(
    nsim = nsim, # Number of simulations
    sampleSize = sampleSize, # Trial sample size
    targetEvents = targetEvents, # Targeted events at analysis
    enrollStrata = enrollStrata, # Study strata
    enrollRates = enrollRates, # Enrollment rates
    failRates = failRatesAll, # Failure rates
    totalDuration = totalDuration, # Planned trial duration
    block = block, # Block for treatment
    timingType = timingType, # Use all possible data cutoff methods
    rg = rg, # FH test(s) to use; in this case, logrank
    setSeed = TRUE
  )
  times[1] <- difftime(Sys.time(), start, units = "sec")[[1]]
  
  # In parallel
  for (i in 2:length(cores)) {
    registerDoParallel(cores[i])
    start <- Sys.time()
    sp <- simfix(
      nsim = nsim, # Number of simulations
      sampleSize = sampleSize, # Trial sample size
      targetEvents = targetEvents, # Targeted events at analysis
      enrollStrata = enrollStrata, # Study strata
      enrollRates = enrollRates, # Enrollment rates
      failRates = failRatesAll, # Failure rates
      totalDuration = totalDuration, # Planned trial duration
      block = block, # Block for treatment
      timingType = timingType, # Use all possible data cutoff methods
      rg = rg, # FH test(s) to use; in this case, logrank
      setSeed = TRUE
    )
    times[i] <- difftime(Sys.time(), start, units = "sec")[[1]]
    message("Results are identical: ", identical(s, sp))
  }

  return (times)
}

runSimfixNew <- function(nsim = 1000, # Number of simulations
                         sampleSize = 800, # Trial sample size
                         targetEvents = 350, # Targeted events at analysis
                         totalDuration = 30, # Planned trial duration
                         timingType = 1:5, # Use all possible data cutoff methods
                         cores = c(1, 2, 4, 6, 8)
                         ) {
  times <- rep(0, length(cores))

  # In serial
  registerDoParallel(1)
  start <- Sys.time()
  s <- simfixNew(
    nsim = nsim, # Number of simulations
    sampleSize = sampleSize, # Trial sample size
    targetEvents = targetEvents, # Targeted events at analysis
    enrollStrata = enrollStrata, # Study strata
    enrollRates = enrollRates, # Enrollment rates
    failRates = failRatesAll, # Failure rates
    totalDuration = totalDuration, # Planned trial duration
    block = block, # Block for treatment
    timingType = timingType, # Use all possible data cutoff methods
    rg = rg, # FH test(s) to use; in this case, logrank
    setSeed = TRUE
  )
  times[1] <- difftime(Sys.time(), start, units = "sec")[[1]]
  
  # In parallel
  for (i in 2:length(cores)) {
    registerDoParallel(cores[i])
    start <- Sys.time()
    sp <- simfixNew(
      nsim = nsim, # Number of simulations
      sampleSize = sampleSize, # Trial sample size
      targetEvents = targetEvents, # Targeted events at analysis
      enrollStrata = enrollStrata, # Study strata
      enrollRates = enrollRates, # Enrollment rates
      failRates = failRatesAll, # Failure rates
      totalDuration = totalDuration, # Planned trial duration
      block = block, # Block for treatment
      timingType = timingType, # Use all possible data cutoff methods
      rg = rg, # FH test(s) to use; in this case, logrank
      setSeed = TRUE
    )
    times[i] <- difftime(Sys.time(), start, units = "sec")[[1]]
    message("Results are identical: ", identical(s, sp))
  }

  return (times)
}
```

# Number of available cores
```{r detectCores}
detectCores()
```

# Experiments

## 1000 simulations
```{r 1000sims}
n_sim <- 1000 # number of simulations in simfix
cores <- c(1, 2, 4, 6, 8) # must start with 1

# Run simfix and simfixNew in serial and in parallel
times_1000 <- runSimfix(nsim = n_sim, cores = cores)
times_1000_new <- runSimfixNew(nsim = n_sim, cores = cores)

# Reshape timing results for plot
df_times_1000 <- data.frame(x = cores,
                           y = c(times_1000,
                                 times_1000_new),
                           group = c(rep("simfix", length(cores)),
                                     rep("simfixNew", length(cores))))
ggplot(df_times_1000, aes(x, y, col = group)) +
  geom_line() +
  scale_x_continuous(breaks = cores) +
  labs(x = "cores", y = paste0("time (sec)"))

# Table
kable(t(data.frame(cores = as.character(cores),
                   simfix = times_1000,
                   simfixNew = times_1000_new)))
```

## 10000 simulations
```{r 10000sims}
n_sim <- 10000 # number of simulations in simfix
cores <- c(1, 2, 4, 6, 8) # must start with 1

# Run simfix and simfixNew in serial and in parallel
times_10000_new <- runSimfixNew(nsim = n_sim)
times_10000 <- runSimfix(nsim = n_sim)

# Reshape timing results for plot
df_times_10000 <- data.frame(x = cores,
                             y = c(times_10000,
                                   times_10000_new),
                             group = c(rep("simfix", length(cores)),
                                       rep("simfixNew", length(cores))))
ggplot(df_times_10000, aes(x, y, col = group)) +
  geom_line() +
  scale_x_continuous(breaks = cores) +
  labs(x = "cores", y = paste0("time (sec)"))

# Table
kable(t(data.frame(cores = as.character(cores),
                   simfix = times_10000,
                   simfixNew = times_10000_new)))
```
